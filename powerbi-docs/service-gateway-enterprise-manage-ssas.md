---
title: Управление своим источником данных — службы Analysis Services
description: Сведения об управлении локальным шлюзом данных и источниками, которые к нему относятся. Эти сведения относятся к службам Analysis Services при работе как в многомерном, так и в табличном режимах.
author: mgblythe
manager: kfile
ms.reviewer: ''
ms.service: powerbi
ms.subservice: powerbi-gateways
ms.topic: conceptual
ms.date: 07/15/2019
ms.author: mblythe
LocalizationGroup: Gateways
ms.openlocfilehash: 93475f6476f8baad73229473bd3ce60db68a320b
ms.sourcegitcommit: 277fadf523e2555004f074ec36054bbddec407f8
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/16/2019
ms.locfileid: "68271660"
---
# <a name="manage-your-data-source---analysis-services"></a>Управление своим источником данных — службы Analysis Services

[!INCLUDE [gateway-rewrite](includes/gateway-rewrite.md)]

После [установки локального шлюза данных](/data-integration/gateway/service-gateway-install) нужно [добавить источники данных](service-gateway-data-sources.md#add-a-data-source), которые можно будет с ним использовать. В этой статье рассмотрены способы работы со шлюзами и источниками данных Analysis Services, которые используются для запланированного обновления или динамических подключений.

Дополнительные сведения о настройке динамического подключения к Analysis Services см. в [этом видео](https://www.youtube.com/watch?v=GPf0YS-Xbyo&feature=youtu.be).

> [!NOTE]
> Если у вас есть источник данных Analysis Services, необходимо установить шлюз на компьютере, присоединенном к тому же лесу или домену, что и сервер служб Analysis Services.

## <a name="add-a-data-source"></a>Добавление источника данных

Сведения о том, как добавить источник данных, см. в статье [Добавление источника данных](service-gateway-data-sources.md#add-a-data-source). Выберите Analysis Services в поле **Тип источника данных**, если подключаетесь к серверу с табличными или многомерными моделями.

![Добавление источника данных Analysis Services](media/service-gateway-enterprise-manage-ssas/datasourcesettings2-ssas.png)

После этого заполните сведения об источнике данных, включая значения **Сервер** и **База данных**. Указанные вами **имя пользователя** и **пароль** будут использоваться шлюзом для подключения к экземпляру служб Analysis Services.

> [!NOTE]
> У указанной вами учетной записи Windows должны быть права администратора сервера для экземпляра, к которому вы подключаетесь. Если для пароля задано истечение срока действия и он не был обновлен для источника данных, у пользователей может возникнуть ошибка подключения. Дополнительные сведения о хранении учетных данных см. в статье [Хранение зашифрованных учетных данных в облаке](service-gateway-data-sources.md#storing-encrypted-credentials-in-the-cloud).

![Задание параметров источников данных](media/service-gateway-enterprise-manage-ssas/datasourcesettings3-ssas.png)

Заполнив все данные, нажмите кнопку **Добавить**. Теперь этот источник данных можно использовать для запланированного обновления или активных подключений для локального экземпляра служб Analysis Services. В случае успеха появится сообщение *Подключение установлено* .

![Отображение состояния подключения](media/service-gateway-enterprise-manage-ssas/datasourcesettings4.png)

### <a name="advanced-settings"></a>Дополнительные настройки

Для источника данных также можно настроить уровень конфиденциальности. Он определяет, каким образом можно комбинировать данные. Используется только для запланированного обновления. Не применяется к активным подключениям. Дополнительные сведения об уровнях конфиденциальности для источника данных см. в статье [Уровни конфиденциальности (Power Query)](https://support.office.com/article/Privacy-levels-Power-Query-CC3EDE4D-359E-4B28-BC72-9BEE7900B540).

![Настройка уровня конфиденциальности](media/service-gateway-enterprise-manage-ssas/datasourcesettings9.png)

## <a name="usernames-with-analysis-services"></a>Имена пользователей в службах Analysis Services

<iframe width="560" height="315" src="https://www.youtube.com/embed/Qb5EEjkHoLg" frameborder="0" allowfullscreen></iframe>

Каждый раз, когда пользователь взаимодействует с отчетом, подключенным к службам Analysis Services, действующее имя пользователя передается в шлюз, а затем на локальный сервер служб Analysis Services. В качестве имени пользователя в службы Analysis Services передается адрес электронной почты, с которым вы вошли в Power BI. Для его передачи используется свойство подключения [EffectiveUserName](https://msdn.microsoft.com/library/dn140245.aspx#bkmk_auth). Этот адрес электронной почты должен совпадать с именем субъекта-пользователя, определенным в локальном домене Active Directory. Имя участника-пользователя является свойством учетной записи Active Directory. Соответствующая учетная запись Windows должна присутствовать в роли Analysis Services. Если совпадение в Active Directory не обнаружено, выполнить вход не удастся. Дополнительные сведения об Active Directory и именовании пользователей см. в статье [Атрибуты именования пользователей](https://msdn.microsoft.com/library/ms677605.aspx).

Также можно [сопоставить имя для входа Power BI с именем субъекта-пользователя локального каталога](service-gateway-enterprise-manage-ssas.md#mapping-usernames-for-analysis-services-data-sources).

## <a name="mapping-usernames-for-analysis-services-data-sources"></a>Сопоставление имен пользователей для источников данных Analysis Services

<iframe width="560" height="315" src="https://www.youtube.com/embed/eATPS-c7YRU" frameborder="0" allowfullscreen></iframe>

В Power BI можно сопоставлять имена пользователей для источников данных Analysis Services. Вы можете настроить правила сопоставления имени пользователя, выполнившего вход в Power BI, с именем, которое передается в свойстве EffectiveUserName для подключения служб Analysis Services. Это удобный способ в ситуации, когда имя пользователя в AAD не соответствует имени участника-пользователя (UPN) в локальной службе Active Directory. Например, адрес электронной почты nancy@contoso.onmicrsoft.com можно сопоставить с адресом nancy@contoso.com, и это значение будет передано шлюзу.

Сопоставить имена пользователей для Analysis Services можно двумя разными способами:

* Повторное сопоставление имен пользователей вручную.
* Поиск свойства в локальном каталоге Active Directory для повторного сопоставления имен участников-пользователей AAD с именами пользователей Active Directory (сопоставление поиска в AD).

Хотя сопоставление можно выполнить вручную на основе второго подхода, это трудно реализовать и занимает много времени. Это особенно трудно, если сопоставления шаблонов недостаточно, например если имена доменов отличаются в AAD и локальном каталоге AD или если имена учетных записей пользователей разные в AAD и AD. Поэтому мы не советуем выполнять сопоставление вручную на основе второго подхода.

Мы описали эти подходы в следующих двух разделах.

### <a name="manual-user-name-re-mapping"></a>Повторное сопоставление имен пользователей вручную

Для источников данных служб Analysis Services можно настроить пользовательские правила имени субъекта-пользователя (UPN). Это поможет вам при несоответствии имен входа службы Power BI имени субъекта-пользователя локального каталога. Например, если вход в Power BI выполняется с именем john@contoso.com, а имя субъекта-пользователя локального каталога — john@contoso.local, можно настроить правило сопоставления для передачи john@contoso.local в службы Analysis Services.

Чтобы открыть экран сопоставления имени субъекта-пользователя, выполните приведенные ниже действия.

1. Щелкните значок **шестеренки** и выберите **Управление шлюзами**.
2. Разверните шлюз, содержащий источник данных служб Analysis Services. Если вы еще не создали источник данных служб Analysis Services, это можно сделать на этом этапе.
3. Выберите источник данных и откройте вкладку **Пользователи**.
4. Выберите **Сопоставление имен пользователей**.

    ![Экран сопоставления имени субъекта-пользователя](media/service-gateway-enterprise-manage-ssas/gateway-enterprise-map-user-names_02.png)

После этого отображаются параметры для добавления правил, а также тестирования для заданного пользователя.

> [!NOTE]
> Вы можете случайно изменить не того пользователя, которого намеревались. Например, если параметр **Replace (original value)** (Заменить: исходное значение) имеет значение <em>@contoso.com</em>, а параметр **With (New name)** (На: новое значение) — значение <em>@contoso.local</em>, для всех пользователей, имя для входа которых содержит <em>@contoso.com</em>, будет выполнена замена на <em>@contoso.local</em>. Кроме того, если параметр **Replace (Original name)** (Заменить: исходное имя) имеет значение <em>dave@contoso.com</em>, а параметр **With (New name)** (На: новое значение) — значение <em>dave@contoso.local</em>, пользователь, имя для входа которых содержит v-dave@contoso.com, будет обработан как v-dave<em>@contoso.local</em>.

### <a name="ad-lookup-mapping"></a>Сопоставление поиска в AD

Чтобы выполнить поиск свойства в локальном каталоге AD для повторного сопоставления имен участников-пользователей AAD с именами пользователей Active Directory, выполните действия в этом разделе. Вначале рассмотрим принцип работы.

В **службе Power BI** происходит следующее:

* Вместе з каждым запросом, отправленным пользователем Power BI AAD локальному серверу SSAS, передается также строка имени участника-пользователя, например firstName.lastName@contoso.com

> [!NOTE]
> Все ручные сопоставления имен участника-пользователя, определенные в конфигурации источника данных Power BI, по-прежнему применяются *перед* отправкой строки с именем пользователя в локальный шлюз данных.

В локальном шлюзе данных с настраиваемым сопоставлением имен пользователей сделайте следующее:

1. Найдите каталог Active Directory для поиска (автоматический или настраиваемый).
2. Найдите атрибут пользователя AD, например *электронная почта*, на основе входящей строки имени участника-пользователя (firstName.lastName@contoso.com) из **службы Power BI**.
3. Если поиск в Active Directory завершается сбоем, в качестве имени действующего пользователя SSAS используется переданное имя участника-пользователя.
4. Если поиск в AD происходит успешно, возвращается атрибут *UserPrincipalName* пользователя AD.
5. Он передает на сервер SSAS адрес электронной почты *UserPrincipalName* в качестве *EffectiveUser*, например <em>Alias@corp.on-prem.contoso</em>.

Порядок настройки шлюза для выполнения поиска в AD:

1. [Скачайте и установите последнюю версию шлюза](/data-integration/gateway/service-gateway-install).

2. Измените **службу локального шлюза данных**, чтобы поиск выполнялся с помощью учетной записи домена, а не учетной записи локальной службы. Иначе функция поиска в AD не будет правильно работать в среде выполнения. Откройте [приложение локального шлюза данных](/data-integration/gateway/service-gateway-app) на компьютере, а затем выберите **Параметры службы > Изменить учетную запись службы**. Запишите ключ восстановления этого шлюза, так как вам потребуется восстановить его на том же компьютере, если вы не планируете создать другой шлюз. Чтобы изменения вступили в силу, необходимо перезапустить службу шлюза.

3. Перейдите в папку установки шлюза (*C:\Program Files\On-premises data gateway*) с правами администратора, чтобы иметь разрешения на запись, и откройте файл *Microsoft.PowerBI.DataMovement.Pipeline.GatewayCore.dll.config*.

4. Измените два приведенных ниже значения конфигурации в соответствии с *вашей* конфигурацией атрибута Active Directory для пользователей AD. Эти значения конфигурации приведены в качестве примера. Их следует указать на основе конфигурации Active Directory. Эти конфигурации чувствительны к регистру, поэтому убедитесь, что они соответствуют значениям в Active Directory.

    ![Параметры Azure Active Directory](media/service-gateway-enterprise-manage-ssas/gateway-enterprise-map-user-names_03.png)

    Если значение для конфигурации ADServerPath не указано, шлюз использует глобальный каталог по умолчанию. Вы также можете указать несколько значений для ADServerPath. Значения должны разделяться точкой с запятой, как показано в следующем примере.

    ```xml
    <setting name="ADServerPath" serializeAs="String">
        <value> >GC://serverpath1; GC://serverpath2;GC://serverpath3</value>
    </setting>
    ```

    Шлюз анализирует значения для ADServerPath слева направо, пока не находит соответствие. Если совпадений не найдено, используется исходное имя субъекта-пользователя. Убедитесь, что учетная запись для службы шлюза (PBIEgwService) имеет разрешения на запрос во всех серверах AD, указанных в ADServerPath.

    Шлюз поддерживает два типа ADServerPath, как показано в следующих примерах.

    **WinNT**

    ```xml
    <value="WinNT://usa.domain.corp.contoso.com,computer"/>
    ```

    **GC**

    ```xml
    <value> GC://USA.domain.com </value>
    ```

5. Чтобы изменения вступили в силу, перезапустите службу **локального шлюза данных**.

### <a name="working-with-mapping-rules"></a>Работа с правилами сопоставления

Чтобы создать правило сопоставления, введите значение для параметра **Исходное имя** и **Новое имя**, а затем выберите **Добавить**.

| Поле | Описание |
| --- | --- |
| Заменить: исходное имя |Адрес электронной почты, с помощью которого вы вошли в Power BI. |
| With (New Name) (На: новое имя) |Значение, на которое требуется заменить предыдущее. Результат замены заключается в том, что именно будет передаваться в свойство *EffectiveUserName* для соединения служб Analysis Services. |

![Создание правила сопоставления](media/service-gateway-enterprise-manage-ssas/gateway-enterprise-map-user-names-effective-user-names.png)

При выборе элемента в списке можно изменить его порядок, используя **значки со стрелками вверх/вниз** или выбрав элемент **Удалить** для записи.

![Изменение порядка элемента в списке](media/service-gateway-enterprise-manage-ssas/gateway-enterprise-map-user-names-entry-selected.png)

### <a name="using-wildcard-"></a>Использование подстановочного знака (\*)

Для строки **Replace (Original name)** (Заменить: исходное имя) можно использовать подстановочный знак. Его можно использовать только самостоятельно, а не с какой-либо другой частью строки. Это позволит использовать всех пользователей и передавать единое значение в источник данных. Это полезно, когда необходимо, чтобы все пользователи в организации использовали в локальной среде одного и того же пользователя.

### <a name="test-a-mapping-rule"></a>Проверка правила сопоставления

Можно проверить, на что заменяется исходное имя, введя значение в поле **Исходное имя** и выбрав **Тестировать правило**.

![Проверка правила сопоставления](media/service-gateway-enterprise-manage-ssas/gateway-enterprise-test-mapping-rule.png)

> [!NOTE]
> Когда правила сохранены, потребуется несколько минут, чтобы служба начала их использовать. В браузере правило начнет действовать немедленно.

### <a name="limitations-for-mapping-rules"></a>Ограничения для правил сопоставления

Сопоставление предназначено для конкретного настроенного источника данных. Это не глобальные параметры. Если имеется несколько источников данных Analysis Services, нужно сопоставить пользователей с каждым из них.

## <a name="authentication-to-a-live-analysis-services-data-source"></a>Проверка подлинности на динамическом источнике данных Analysis Services

Каждый раз, когда пользователь взаимодействует со службами Analysis Services, действующее имя пользователя передается в шлюз, а затем на локальный сервер служб Analysis Services. В качестве имени пользователя в Analysis Services передается имя субъекта-пользователя (как правило, это адрес электронной почты, с помощью которого вы вошли в облачную службу). Для его передачи используется свойство подключения EffectiveUserName. Этот адрес электронной почты должен совпадать с именем участника-пользователя, определенным в локальном домене Active Directory. Имя участника-пользователя является свойством учетной записи Active Directory. Для доступа к серверу соответствующая учетная запись Windows должна присутствовать в роли Analysis Services. Если совпадение в Active Directory не обнаруживается, выполнить вход не удается.

Службы Analysis Services также могут выполнять фильтрацию на основе данной учетной записи. Фильтрация выполняется на уровне роли или на уровне строк.

## <a name="role-based-security"></a>Безопасность на основе ролей

Модели обеспечивают безопасность на основе ролей пользователей. Роли задаются для конкретного проекта модели на этапе разработки в средствах бизнес-аналитики SQL Server Data Tools (SSDT-BI) или после развертывания модели с помощью SQL Server Management Studio (SSMS). Членами ролей могут быть имена пользователей Windows или группы Windows. Роли определяют разрешения, которые имеются у пользователя для выполнения запросов или действий в модели. Большинство пользователей будут принадлежать к роли с разрешениями на чтение. Другие роли предназначены для администраторов и имеют разрешения на обработку элементов, управление функциями базы данных и управление другими ролями.

## <a name="row-level-security"></a>Безопасность на уровне строк

Безопасность на уровне строк — это функция Analysis Services. Модели могут обеспечивать динамическую безопасность на уровне строк. Пользователь должен принадлежать хотя бы к одной роли; в отличие от этого, динамическая безопасность не является обязательной для любой табличной модели. На высоком уровне динамическая безопасность определяет доступ пользователей на чтение данных непосредственно в определенной строке в определенной таблице. Аналогично ролям, динамическая безопасность на уровне строк основывается на имени пользователя Windows.

Возможность пользователя запрашивать и просматривать данные модели определяется в первую очередь ролями, к которым относится его учетная запись пользователя Windows, а во вторую очередь — параметрами динамической безопасности на уровне строк, если они настроены.

Реализация безопасности на основе ролей и динамической безопасности на уровне строк в моделях в этой статье не рассматривается. Дополнительные сведения см. в статьях [Роли (табличные службы SSAS)](https://msdn.microsoft.com/library/hh213165.aspx) и [Роли безопасности (службы Analysis Services — многомерные данные)](https://msdn.microsoft.com/library/ms174840.aspx) в MSDN. Чтобы максимально полно разобраться в безопасности табличной модели, скачайте и прочтите технический документ [Безопасность в табличной семантической модели бизнес-аналитики](https://msdn.microsoft.com/library/jj127437.aspx).

## <a name="what-about-azure-active-directory"></a>Об Azure Active Directory

В облачных службах Майкрософт для проверки подлинности пользователей применяется каталог [Azure Active Directory](/azure/active-directory/fundamentals/active-directory-whatis). Azure Active Directory — это клиент, содержащий имена пользователей и сведения о группах безопасности. Как правило, адрес электронной почты, с которым пользователь выполняет вход, совпадает с именем участника-пользователя учетной записи.

Каковы функции локального каталога Active Directory?

Чтобы службы Analysis Services могли определить, относится ли подключившийся к ним пользователь к роли с разрешениями на чтение данных, сервер должен преобразовать действующее имя пользователя, переданное из AAD в шлюз, а затем на сервер служб Analysis Services. Сервер Analysis Services передает действующее имя пользователя на контроллер домена Windows Active Directory. Затем контроллер домена Active Directory проверяет, является ли действующее имя пользователя действительным именем участника-пользователя в локальной учетной записи, и возвращает его имя пользователя Windows обратно на сервер служб Analysis Services.

Параметр EffectiveUserName нельзя использовать в на сервере Analysis Services, который не присоединен к домену. Чтобы избежать ошибок при входе, локальный сервер Analysis Services должен входить в домен.

### <a name="how-do-i-tell-what-my-upn-is"></a>Как узнать свое имя участника-пользователя?

Вы можете не знать свое имя участника-пользователя и не являться администратором домена. Чтобы узнать имя участника-пользователя для учетной записи, можно использовать следующую команду на рабочей станции.

    whoami /upn

Имя субъекта-пользователя для учетной записи домена будет похоже на адрес электронной почты. Если для динамических подключений используется источник данных Analysis Services, но эти данные не соответствуют адресу электронной почты, с помощью которого вы входите в Power BI, ознакомьтесь с [сопоставлением имен пользователей](#mapping-usernames-for-analysis-services-data-sources).

## <a name="synchronize-an-on-premises-active-directory-with-azure-active-directory"></a>Синхронизация локальной Active Directory с Azure Active Directory

Если вы планируете работать с динамическими подключениями Analysis Services, учетные записи в вашем локальном каталоге Active Directory должны соответствовать содержимому Azure Active Directory. В частности, должны совпадать имена участников-пользователей.

Облачным службам известно только об учетных записях, которые хранятся в каталоге Azure Active Directory. Неважно, добавили ли вы соответствующую запись в локальную службу Active Directory: если ее нет в AAD, использовать ее нельзя. Синхронизировать учетные записи в локальном каталоге Active Directory со службой Azure Active Directory можно разными способами.

1. Вы можете вручную добавить учетные записи в Azure Active Directory.

   Вы можете создать учетную запись, имя которой будет совпадать с именем участника-пользователя учетной записи в локальном каталоге Active Directory, на портале Azure или на портале администрирования Microsoft 365.

2. Вы можете синхронизировать локальные учетные записи со своим клиентом Azure Active Directory с помощью средства [Azure AD Connect](/azure/active-directory/hybrid/how-to-connect-sync-whatis).

   Средство Azure AD Connect предоставляет возможности синхронизации каталогов и настройки аутентификации, включая синхронизацию хэшей паролей, сквозную аутентификацию и федерацию. Если вы не являетесь администратором клиента или локального домена, для их настройки вам потребуется обратиться к своему ИТ-администратору.

Приложение Azure AD Connect помогает обеспечить соответствие между именами участников-пользователей в AAD и локальном каталоге Active Directory.

> [!NOTE]
> При синхронизации учетных записей с помощью Azure AD Connect создаются новые учетные записи в клиенте AAD.

## <a name="using-the-data-source"></a>Работа с источником данных

После создания источника данных он будет доступен для использования с динамическими подключениями или через функцию запланированного обновления.

> [!NOTE]
> Имена сервера и базы данных в Power BI Desktop и источнике данных в конфигурации локального шлюза должны совпадать.

Связь между набором и источником данных в пределах шлюза основана на именах сервера и базы данных. Они должны совпадать. Например, если вы указали IP-адрес в качестве имени сервера в Power BI Desktop, необходимо будет использовать такой IP-адрес и для источника данных в конфигурации шлюза. Если вы используете формат *СЕРВЕР\ЭКЗЕМПЛЯР* в Power BI Desktop, нужно использовать тот же формат и в источнике данных, настроенном для шлюза.

Это условие справедливо и для динамических подключений, и для запланированного обновления.

### <a name="using-the-data-source-with-live-connections"></a>Использование источника данных с динамическими подключениями

Имена сервера и базы данных должны совпадать в Power BI Desktop и источнике данных для шлюза. Кроме того, для публикации наборов данных динамических подключений ваша учетная запись должна быть указана на вкладке **Пользователи** источника данных. Выбор для динамических подключений выполняется в Power BI Desktop при импорте данных.

После публикации (из Power BI Desktop или окна **Получение данных**) ваши отчеты должны начать работать. Установка подключения после создания источника данных в рамках шлюза может занять несколько минут.

### <a name="using-the-data-source-with-scheduled-refresh"></a>Использование источника данных с запланированным обновлением

Если вы указаны на вкладке **Пользователи** источника данных, настроенного в шлюзе, а имена сервера и базы данных совпадают, вы увидите шлюз в списке вариантов, доступных для использования с запланированным обновлением.

![Отображение пользователей](media/service-gateway-enterprise-manage-ssas/powerbi-gateway-enterprise-schedule-refresh.png)

### <a name="limitations-of-analysis-services-live-connections"></a>Ограничения для динамических подключений к службам Analysis Services

С помощью динамического подключения можно работать с табличными и с многомерными экземплярами.

| **Версия сервера** | **Требуемый номер SKU** |
| --- | --- |
| 2012 SP1 CU4 или более поздняя версия |Бизнес-аналитика и SKU категории "корпоративный" |
| 2014 |Бизнес-аналитика и SKU категории "корпоративный" |
| 2016 |SKU категории "стандартный" или старшая версия |

* Функции форматирования на уровне ячеек и перевода не поддерживаются.
* Из Power BI недоступны действия и именованные наборы, но вы можете подключаться к многомерным кубам, которые их содержат, и создавать визуальные элементы и отчеты.

## <a name="next-steps"></a>Дальнейшие действия

* [Устранение неполадок локального шлюза данных](/data-integration/gateway/service-gateway-tshoot)
* [Устранение неполадок со шлюзами — Power BI](service-gateway-onprem-tshoot.md)

Появились дополнительные вопросы? [Ответы на них см. в сообществе Power BI.](http://community.powerbi.com/)

